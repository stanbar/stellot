<!-- Test Account -->
<!-- GAM7ZPJQOM345NBLEZY23UN2ORHLJ6XMFZOTENGLGCBF6JNNWUXBU6QN -->
<!-- SBOMRZ4BFPU2PZTAFSQIMRLUMX5RQDXYVJRACPEG5D4PIANYJ7MUBSH2 -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Voting Stellar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Voting system build on stellar network" />
    <meta name="author" content="Stanislaw Baranski" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  </head>

  <body>
    <div id="app" class="container">
      <h1>Voting system build on stellar network</h2>
      <h2>{{ distributionAccountId }}</h2>
      Tokens remaining: {{ tokensRemaining }}
      <button @click="trustIssuer" class="btn btn-primary">Trust issuer</button>
      <br/>

      <h2>Issue a vote token</h2>
      <form @submit.prevent="onIssueTokenSubmit">
        <div class="form-group">
					<label for="pesel">PESEL:</label>
					<input id="pesel" type="text" placeholder="95031801245" v-model="pesel" required class="form-control"/>
				</div>
        <br/>

        <div class="form-group">
					<label for="address">Stellar Address:</label>
					<input id="address" placeholder="GA3WFG5ZB4CCEU6JOOTLQ5QPG73EX5E5MM5GZJEJ7CFLY7XZYSG73LEU" type="text" v-model="address" required class="form-control"/>
				</div>

        <br/>
        <input type="submit" value="Submit"/>
      </form>
      <br/>

      <h2>Parties</h2>
      <ul>
        <li v-for="party in parties" :key="party.name">
          <input type="number" v-model.number="party.votes" />
          {{ party.name }} {{ party.votes }}
          <button @click="party.votes += 1">Add</button>
        </li>
      </ul>
      {{ totalVotes }}
    </div>

    <script src="https://unpkg.com/vue"></script>
    <script>
      const app = new Vue({
        el: '#app',
        data: {
          distributionAccountId:
            'GA3WFG5ZB4CCEU6JOOTLQ5QPG73EX5E5MM5GZJEJ7CFLY7XZYSG73LEU',
          issuerAccountId:'GBCKKOTXWVHRHTWWSKN53HD3BMVXZCOFJAINKHL7YGGTXCFDVD7FMJSH',
          assetCode: 'Vote01122019',
          parties: [
            {
              name: 'PiS',
              address:
                'GCY4TQKOGQ7DL5ZOSF3FEQ2NPN2N3LHDHS7TRU5Y4QKVLOVJVCJRK3SM',
            },
            {
              name: 'PO',
              address:
                'GDW5VG4ASNEV5SBH2LSGMRPQLJYIMO7DJD7YY2ELN6CKSZYXT2IMBPYR',
            },
            {
              name: 'Konfederacja',
              address:
                'GBT5LTIVSBBN3JZMVPJ6ANKECXOSNY2C7DSBJBKWE6EP6LD5AFJNJZGB',
            },
            {
              name: 'Authoritarianism',
              address:
                'GBYKYTZQHKV5HAV5WFBNOWRWQK3TNWFFZV6VCBEDKXIZXCYG6JSLQ4VL',
            },
          ],
          tokensRemaining : 0,
          pesel: undefined,
          address: undefined
        },
        async created() {
          const res = await fetch(
            `https://horizon-testnet.stellar.org/accounts/${this.distributionAccountId}`,
          )
          const json = await res.json()
          const balance = json.balances.find((balance =>
            balance.asset_code === this.assetCode && balance.asset_issuer === this.issuerAccountId))
          const tokensRemaining = Math.round(balance.balance * 10 ** 7)
          this.tokensRemaining = tokensRemaining
        },
        computed: {
          totalVotes() {
            return this.parties.reduce((sum, party) => {
              return sum + party.votes
            }, 0)
          },
        },
        methods: {
          async trustIssuer() {
            // TODO
          },
          async onIssueTokenSubmit() {
            const address = this.address
            const pesel = this.pesel
            const request = { address, pesel}
            console.log(request)
            try {
              const response = await fetch('/issueToken', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(request)
              })
              if(response.ok){
                console.log('Successfully assigned vote token')
              }else{
                console.error('Failed to assign vote token')
              }
            } catch (e) {
              console.error(e)
            }
          }
        },
      })
    </script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  </body>
</html>
